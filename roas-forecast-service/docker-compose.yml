version: '3.9'
services:
  clickhouse:
    image: clickhouse/clickhouse-server:24.9
    ports:
      - '8123:8123'
      - '9000:9000'
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    environment:
      CLICKHOUSE_HOST: clickhouse
      CLICKHOUSE_PORT: '8123'
      CLICKHOUSE_DB: roas
    depends_on:
      - clickhouse
    ports:
      - '8000:8000'
  
  migrate:
    image: clickhouse/clickhouse-server:24.9
    depends_on:
      - clickhouse
    volumes:
      - ./sql:/sql:ro
    entrypoint: ["/bin/bash","-lc"]
    command: >
      "until clickhouse-client --host clickhouse --query 'SELECT 1' >/dev/null 2>&1;
       do echo 'waiting for clickhouse...'; sleep 1; done;
       clickhouse-client --host clickhouse --multiquery < /sql/schema.sql"


